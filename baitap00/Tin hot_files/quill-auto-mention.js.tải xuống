(function() {
    var _extends = Object.assign || function (target) {
        for (var i = 1; i < arguments.length; i++) {
            var source = arguments[i];
            for (var key in source) {
                if (Object.prototype.hasOwnProperty.call(source, key)) {
                    target[key] = source[key];
                }
            }
        }
        return target;
    };

    function _classCallCheck(instance, Constructor) {
        if (!(instance instanceof Constructor)) {
            throw new TypeError("Cannot call a class as a function");
        }
    }

    var DEFAULT_OPTIONS = {
        paste: true,
        type: true,
        regexp: /\@[^\s]{3,}/
    };

    var REGEXP = DEFAULT_OPTIONS.regexp;
    const maxLength = 15;

    function registerTypeListener(quill) {
        quill.keyboard.addBinding({
            collapsed: true,
            key: ' ',
            prefix: REGEXP,
            handler: function () {
                return function (range) {
                    return formatMention(quill, range);
                };
            }()
        });
        quill.keyboard.bindings[13].unshift({
            collapsed: true,
            key: 'enter',
            prefix: REGEXP,
            handler: function () {
                return function (range) {
                    return formatMention(quill, range);
                };
            }()
        });
    }

    function registerPasteListener(quill) {
        quill.clipboard.addMatcher(Node.TEXT_NODE, function (node, delta) {
            if (typeof node.data !== 'string') {
                return;
            }
            var matches = node.data.match(REGEXP);
            if (matches && matches.length > 0) {
                var ops = [];
                var str = node.data;
                matches.forEach(function (match) {
                    var split = str.split(match);
                    var before = split.shift();
                    ops.push({insert: before});
                    ops.push({
                        insert: {
                            mention: {
                                denotationChar: '@',
                                id: '',
                                value: match.replace(/\@/g, ''),
                            }
                        }
                    });
                    ops.push({insert: ' '});
                    str = split.join(match);
                });
                ops.push({insert: str});
                delta.ops = ops;
            }

            return delta;
        });
    }

    var formatMention = function (quill, range) {
        var mention = void 0;
        var listText = [];
        contents = quill.getContents().ops;
        for (i = 0; i < contents.length; i++) {
            if (typeof contents[i].insert === "string" && (typeof contents[i].attributes === "undefined" || typeof contents[i].attributes.link === "undefined")) {
                listText.push(contents[i].insert);
            }
        }
        var text = listText.find(item => item.match(REGEXP) !== null)
        if (!text) {
            return true;
        }
        var match = text.match(REGEXP);
        if (match.length > 1) {
            mention = match[match.length - 1];
        } else {
            mention = match[0];
        }
        var ops = [];
        if (range.index > mention.length) {
            ops.push({retain: range.index - mention.length});
        }
        ops.push({'delete': mention.length});
        ops.push({
            insert: {
                mention: {
                    denotationChar: '@',
                    id: '',
                    value: mention.replace(/\@/g, ''),
                }
            }
        });
        quill.updateContents({ops: ops}, Quill.sources.USER);
        return true;
    }

    var AutoMention = function AutoMention(quill) {
        var options = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : {};

        _classCallCheck(this, AutoMention);

        var opts = _extends({}, DEFAULT_OPTIONS, options);

        if (opts.type) {
            registerTypeListener(quill);
        }
        if (opts.paste) {
            registerPasteListener(quill);
        }
    };


    Quill.register('modules/autoMention', AutoMention);
})();
