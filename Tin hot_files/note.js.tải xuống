(function ($) {
    'use strict';

    window.initLinkNoteEditorBox = function () {
        LHLinkPoster._wrap.find('#link-post-url').attr('data-norequire', 1);
        
        $(this).osc_editor({
            image_enable: false,
            scroller: $(this).closest('.osc-wrap')[0],
            inline_mode: false,
            box_min_height: 300,
            box_pathbar_enable: true,
            box_command_data: [['bold italic underline | textColor highlight | heading hr | align_left align_center align_right align_justify | ul ol', 'textbox block_image | clearFormat']],
            plugins: [
                osc_editor_plugin_block_image({block_image_max_item: 1, block_image_zoom_enable: false}),
                osc_editor_plugin_textbox({textbox_zoom_enable: false}),
                osc_editor_plugin_textColor(),
                osc_editor_plugin_highlight()
            ]
        }).bind('processPasteContent', function (e, data) {
            var url_input = LHLinkPoster._wrap.find('#link-post-url');

            if (url_input.val() !== '') {
                return;
            }

            var text = $('<div />').html(data.content).text().trim();

            if (!(/^(https?:\/\/)?((([a-z\d]([a-z\d-]*[a-z\d])*)\.)+[a-z]{2,}|((\d{1,3}\.){3}\d{1,3}))(\:\d+)?(\/[-a-z\d%_.~+]*)*(\?[;&a-z\d%_.~+=-]*)?(\#[-a-z\d_]*)?$/i).test(text)) {
                return;
            }

            e.stopImmediatePropagation();

            $('.link-post-note-link-info').html('').addClass('loading');

            url_input.val(text);

            LHLinkPoster._getUrlInfo(url_input, true);
        });
    };

    $.extend(LHLinkPosterAbstract.prototype, {
        _urlInfoCallback_Note: function (info) {
            var title = info.fb_tags.title ? info.fb_tags.title : info.title;
            var description = info.fb_tags.description ? info.fb_tags.description : info.description;
            var domain = info.domain.replace(/^((http|ftp)s?:)?\/\/([^\/]+)(\/+.*)?$/i, '$3').toLowerCase();
            var image_src = info.fb_tags.image ? info.fb_tags.image.url : (info.embed && info.embed.thumb ? info.embed.thumb : null);

            var scene = $('.link-post-note-link-info');

            scene.html('').removeClass('loading');

            $('<div />').addClass('remove-btn').click(function () {
                LHLinkPoster._wrap.find('#link-post-url').val('');
                scene.html('');
            }).appendTo(scene);

            $('<div />').addClass('url').text(info.url).appendTo(scene);

            if (image_src) {
                $('<div />').addClass('image').attr('data-insert-cb', 'initFitImage').append($('<img />').attr('src', image_src)).appendTo(scene);
            }

            var info_container = $('<div />').addClass('info').appendTo(scene);

            $('<div />').addClass('domain').html(domain).appendTo(info_container);
            $('<div />').addClass('title').html(title).appendTo(info_container);
            $('<div />').addClass('description').html(description).appendTo(info_container);
        },
        _getDataCallback_Note: function (data) {
            data.note_content = $('#link-post-note').osc_editor('getcontent');

            if (!data.note_content) {
                throw {field: 'note', message: 'Bạn cần điền nội dung cho note'};
            }
        }
    });
})(jQuery);