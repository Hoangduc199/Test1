(function ($) {
    'use strict';

    var POPUP = null;

    function OSC_UI_ItemBrowser(node, options) {
        this._initialize = function (node, config) {
            if (typeof config !== 'object') {
                config = {};
            } else {
                for (var x in config) {
                    if (x.substring(0, 1) === '_') {
                        delete(config[x]);
                    }
                }
            }

            $.extend(this, config);

            var $this = this;

            $.each({min_height: {min: 200, default: 200}, page_size: {min: 10, max: 100, default: 25}, page_section: {min: 1, max: 10, default: 3}}, function (name, data) {
                if (data === null) {
                    data = {default: 0};
                } else if (typeof data === 'number') {
                    data = {default: data};
                }

                $this[name] = parseInt($this[name]);

                if (isNaN($this[name])) {
                    $this[name] = data.default;
                } else if (typeof data.min !== 'undefined' && $this[name] < data.min) {
                    $this[name] = data.min;
                } else if (typeof data.max !== 'undefined' && $this[name] > data.max) {
                    $this[name] = data.max;
                }
            });

            $.each(['keywords_cleaner', 'item_render_callback', 'item_render', 'click_callback', 'items_render_callback', 'after_response_callback'], function (k, f) {
                if (typeof $this[f] === 'string') {
                    eval('$this[f] = ' + $this[f]);
                }
            });

            this._id = $.makeUniqid();

            this._container = $(node);

            if (this._container[0].nodeName.toLowerCase() === 'input' && this._container.attr('type') === 'text') {
                this._input = this._container;
            } else {
                this._input = this._container.find('input[type="text"]');
            }

            this._input.attr({autocomplete: 'off'});

            this._container.attr('data-item-browser', this._id);

            this._initEvent();
        };

        this._positionPopup = function () {
            if (POPUP === null || POPUP.attr('data-id') !== this._id) {
                return;
            }

            var margin = 10;

            var win_height = $(window).height();

            var rect = this._container[0].getBoundingClientRect();

            var css_data = {width: parseInt(rect.width) + 'px', left: parseInt(rect.x + $(window).scrollLeft()) + 'px'};

            var top_spacing = parseInt(rect.y) - (margin * 2);
            var bottom_spacing = parseInt(win_height - (rect.y + rect.height)) - (margin * 2);

            var height = POPUP[0].getBoundingClientRect().height;

            var item_list = POPUP.find('.item-list')[0];

            if (item_list) {
                var item_list_height = 0;

                for (var i = 0; i < item_list.childNodes.length; i++) {
                    item_list_height += item_list.childNodes[0].getBoundingClientRect().height;
                }

                if (height > this.max_height && height > bottom_spacing) {
                    height += item_list_height - item_list.getBoundingClientRect().height;

                    var max_height = Math.min(this.max_height, height, Math.max(bottom_spacing, this.min_height));

                    if (max_height > bottom_spacing && top_spacing > bottom_spacing) {
                        max_height = Math.min(this.max_height, height, Math.max(top_spacing, this.min_height));
                    }

                    height = max_height;

                    $(item_list).css('max-height', Math.ceil(height - POPUP[0].getBoundingClientRect().height + item_list.getBoundingClientRect().height) + 'px');
                } else {
                    $(item_list).css('max-height', 'initial');
                }
            }

            if (height > bottom_spacing && top_spacing > bottom_spacing) {
                css_data.bottom = parseInt(win_height - rect.y + margin) + 'px';
            } else {
                css_data.top = parseInt(rect.y + rect.height + margin) + 'px';
            }

            POPUP.removeAttr('style').css(css_data).swapZIndex();
        };

        this._popupIsRendered = function () {
            return POPUP !== null && POPUP.attr('data-id') === this._id;
        };

        this._removePopup = function () {
            POPUP.remove();
            POPUP = null;

            $(window).unbind('.itemBrowser');
            $(document).unbind('.itemBrowser');
        };

        this._renderPopup = function () {
            if (this._popupIsRendered()) {
                return;
            }

            var $this = this;

            this._current_index = -1;

            if (POPUP === null) {
                POPUP = $('<div />').addClass('item-browser-popup').appendTo(document.body);

                $(window).unbind('.itemBrowser').bind('resize.itemBrowser', function (e) {
                    $this._positionPopup();
                }).bind('scroll.itemBrowser', function (e) {
                    $this._positionPopup(e);
                });

                $(document).unbind('.itemBrowser').bind('mousedown.itemBrowser', function (e) {
                    if (e.target && ($(e.target).hasClass('item-browser-popup') || e.target.hasAttribute('data-item-browser') || $(e.target).closest('.item-browser-popup')[0] || $(e.target).closest('[data-item-browser]')[0])) {
                        return;
                    }

                    $this._removePopup();
                });
            }

            POPUP.removeClass('small');

            if (this._container.hasClass('small')) {
                POPUP.addClass('small');
            }

            POPUP.attr('data-id', this._id);
        };

        this._renderLoading = function () {
            this._renderPopup();

            POPUP.html('').removeAttr('data-verify-key');

            $('<div />').addClass('loading').text('Loading...').prepend($.renderIcon('preloader')).appendTo(POPUP);
            this._positionPopup();
        };

        this._renderItems = function () {
            if (!this._browsed_data) {
                return this._browse();
            }

            var $this = this;

            this._renderPopup();

            this._current_page = this._browsed_data.current_page;

            var verify_key = $.md5(this._id + JSON.stringify(this._browsed_data));

            if (POPUP.attr('data-verify-key') === verify_key) {
                return;
            }

            POPUP.html('').attr('data-verify-key', verify_key);

            this._current_index = -1;

            this._input.focus();

            if (this._browsed_data.items.length < 1) {
                $('<div />').addClass('no-item').text('No items were found to display').appendTo(POPUP);
            } else {
                var container = $('<div />').addClass('item-list-wrap').appendTo(POPUP);

                var pagination = buildPager(this._browsed_data.current_page, this._browsed_data.total, this._browsed_data.page_size, {section: this.page_section, small: true});

                var list = $('<div />').addClass('item-list').appendTo(container).keydown(function (e) {
                    if (e.keyCode === 9) { //Tab
                        $this._input.focus();
                    } else if (e.keyCode === 40) { //DOWN
                        $this._selectItem(true);
                    } else if (e.keyCode === 38) { //UP
                        $this._selectItem(false);
                    } else if (e.keyCode === 39) { //RIGHT
                        var next_page_btn = pagination.find('.current')[0].nextSibling;

                        if (next_page_btn) {
                            $(next_page_btn).findAll('[data-page]').trigger('click');
                        }
                    } else if (e.keyCode === 37) { //LEFT
                        var prev_page_btn = pagination.find('.current')[0].previousSibling;

                        if (prev_page_btn) {
                            $(prev_page_btn).findAll('[data-page]').trigger('click');
                        }
                    } else {
                        return;
                    }

                    e.preventDefault();
                });

                this._browsed_data.items.forEach(function (item, index) {
                    if (typeof $this.item_render === 'function') {
                        var node = $this.item_render.apply($this, [item]);
                    } else {
                        var node = $('<a />').attr('href', 'javascript: void(0)').addClass('item');

                        if (typeof item.image !== 'undefined') {
                            $('<div />').addClass('image').css('background-image', 'url(' + item.image + ')').appendTo(node);
                        } else if (typeof item.icon !== 'undefined') {
                            $('<div />').addClass('icon').append($.renderIcon(item.icon)).appendTo(node);
                        }

                        $('<div />').addClass('title').text(item.title).appendTo(node);
                    }

                    if (typeof $this.item_render_callback === 'function') {
                        $this.item_render_callback.apply($this, [node, item]);
                    }

                    node.appendTo(list).hover(function () {
                        $this._selectItem(index, true);
                    }).click(function (e) {
                        if (this.getAttribute('disabled') !== 'disabled' && typeof $this.click_callback === 'function') {
                            $this.click_callback.apply($this, [node, item]);
                        }
                    });
                });

                if (typeof this.items_render_callback === 'function') {
                    this.items_render_callback.apply(this, [list]);
                }

                if (pagination) {
                    $('<div />').addClass('pagination-bar p10').append(pagination).appendTo(container);
                    pagination.find('[data-page]:not(.current)').click(function (e) {
                        e.preventDefault();

                        $this._browse(this.getAttribute('data-page'));
                    });
                }
            }

            this._positionPopup();
        };

        this._getSelectedNode = function () {
            if (!this._popupIsRendered()) {
                return null;
            }

            var list = POPUP.find('.item-list')[0];

            return (list && list.childNodes[this._current_index]) ? list.childNodes[this._current_index] : null;
        };

        this._selectItem = function (index, skip_check_scroll) {
            this._renderItems();

            if (!this._browsed_data) {
                return;
            }

            if (typeof index === 'boolean') {
                if (index) {
                    this._current_index++;
                } else {
                    if (this._current_index < 0) {
                        this._current_index = this._browsed_data.items.length;
                    } else {
                        this._current_index--;
                    }
                }
            } else {
                this._current_index = parseInt(index);

                if (isNaN(this._current_index)) {
                    this._current_index = -1;
                }
            }

            this._current_index = Math.min(this._browsed_data.items.length - 1, Math.max(0, this._current_index));

            var node = this._getSelectedNode();

            if (node) {
                if (!skip_check_scroll) {
                    var node_rect = node.getBoundingClientRect();
                    var list_rect = node.parentNode.getBoundingClientRect();

                    var node_coord_y = node.getBoundingClientRect().y - node.parentNode.getBoundingClientRect().y + $(node.parentNode).scrollTop();

                    if ((node_rect.y + node_rect.height) > (list_rect.y + list_rect.height)) {
                        $(node.parentNode).scrollTop(node_coord_y - list_rect.height + node_rect.height);
                    } else if (node_rect.y < list_rect.y) {
                        $(node.parentNode).scrollTop(node_coord_y);
                    }
                }

                $(node).focus();
            }
        };

        this._initEvent = function () {
            var $this = this;

            this._container.find('[data-browser-toggler]').each(function () {
                $(this).unbind('.itemBrowser').bind('click.itemBrowser', function () {
                    if ($this._popupIsRendered()) {
                        $this._removePopup();
                    } else {
                        $this._renderItems();
                        $this._input.focus();
                    }
                });
            });

            this._input.unbind('.itemBrowser').bind('focus.itemBrowser', function (e) {
                if ($this.focus_browse) {
                    $this._renderItems();
                }
            }).bind('keyup.itemBrowser', function (e) {
                clearTimeout($this._browse_timer);

                if ([13, 32].indexOf(e.keyCode) >= 0) { //ENTER & SPACE
                    $this._browse(null, e.keyCode === 13);
                } else {
                    $this._browse_timer = setTimeout(function () {
                        $this._browse();
                    }, 250);
                }
            }).bind('keydown.itemBrowser', function (e) {
                clearTimeout($this._browse_timer);

                if (e.keyCode === 13) {
                    e.preventDefault();
                } else if (e.keyCode === 40) { //DOWN
                    $this._selectItem(true);
                    return;
                } else if (e.keyCode === 38) { //UP
                    $this._selectItem(false);
                    return;
                }
            });
        };

        this._browse = function (page, force) {
            var $this = this;

            var keywords = searchCleanKeywords(this._input.val());

            if (typeof this.keywords_cleaner === 'function') {
                keywords = this.keywords_cleaner.apply(this, [keywords]);
            }

            if (keywords !== this._last_keywords || force) {
                if (this._xhr) {
                    this._xhr.abort();
                }
            } else {
                if (this._xhr) {
                    return;
                }

                if (this._browsed_data) {
                    page = parseInt(page);

                    if (isNaN(page) || page === this._current_page) {
                        return this._renderItems();
                    }
                }
            }

            var backup_browsed_data = this._browsed_data;

            this._browsed_data = null;

            this._renderLoading();

            var post_data = {};

            if (this.browse_params !== null && typeof this.browse_params === 'object') {
                $.extend(post_data, this.browse_params);
            }

            $.extend(post_data, {keywords: keywords, page: page, page_size: this.page_size});

            this._xhr = $.ajax({
                type: 'POST',
                url: this.browse_url,
                data: post_data,
                success: function (response) {
                    $this._xhr = null;

                    if (response.result !== 'OK') {
                        console.log(response.message);
                    } else {
                        $this._last_keywords = keywords;

                        if (typeof $this.after_response_callback === 'function') {
                            keywords = $this.after_response_callback.apply($this, [response.data]);
                        }
                    }

                    $this._browsed_data = response.result !== 'OK' ? backup_browsed_data : response.data;

                    $this._renderItems();
                },
                error: function (xhr, ajaxOptions, thrownError) {
                    if (thrownError.trim().toLowerCase() !== 'abort') {
                        console.log('ERROR [#' + xhr.status + ']: ' + thrownError);
                    }

                    $this._renderItems();
                }
            });
        };

        this.browse_url = null;
        this.max_height = 500;
        this.min_height = 300;
        this.page_size = 25;
        this.page_section = 4;
        this.keywords_cleaner = null;
        this.click_callback = null;
        this.items_render_callback = null;
        this.item_render_callback = null;
        this.after_response_callback = null;
        this.item_render = null;
        this.focus_browse = false;
        this.browse_params = {};
        this._id = null;
        this._xhr = null;
        this._current_page = 1;
        this._last_keywords = '';
        this._browse_timer = null;
        this._browsed_data = null;
        this._current_index = -1;
        this._container = null;
        this._input = null;

        this._initialize(node, options);
    }

    $.fn.osc_ui_itemBrowser = function () {
        var func = null;

        if (arguments.length > 0 && typeof arguments[0] === 'string') {
            func = arguments[0];
        }

        if (func) {
            var opts = [];

            for (var x = 1; x < arguments.length; x++) {
                opts.push(arguments[x]);
            }
        } else {
            opts = arguments[0];
        }

        return this.each(function () {
            if (func) {
                var instance = $(this).data('osc-ui-itemBrowser');
                instance[func].apply(instance, opts);
            } else {
                $(this).data('osc-ui-itemBrowser', new OSC_UI_ItemBrowser(this, opts));
            }
        });
    };

    window.SEARCH_KEYWORD_MIN_LENGTH = 2;

    window.searchCleanKeywords = function (keywords, deep_clean_mode) {
        keywords = keywords.split(/[ \n\r]+/);

        var buff = [];

        for (var k = 0; k < keywords.length; k++) {
            var keyword = keywords[k].trim();

            var mark = '';

            if (deep_clean_mode) {
                mark = XRegExp.replace(keyword, new XRegExp('^(?=^[^\\p{L}]+)^[^-+]*([-+])[^\\p{L}]*\\p{L}.+', 'g'), '$1');
                keyword = XRegExp.replace(keyword, new XRegExp('[^\\p{L}\\d]', 'g'), '');
            }

            if (keyword.length < SEARCH_KEYWORD_MIN_LENGTH) {
                continue;
            }

            if (mark != '+' && mark != '-') {
                mark = '';
            }

            buff.push(mark + keyword);
        }

        return buff.join(' ');
    };

    window.initItemBrowser = function () {
        var options = {};

        try {
            options = JSON.parse(this.getAttribute('data-browser-config'));
        } catch (e) {
        }

        $(this).osc_ui_itemBrowser(options);
    };
})(jQuery);